name: Bazel CI

on:
  push:
    tags:
      - '*'
      - '*/*'

jobs:
  build-and-test:
    name: Build and Test (${{ matrix.config.name }})
    runs-on: ${{ matrix.config.os }}
    
    strategy:
      matrix:
        config:
          # - name: Linux GCC
          #   os: ubuntu-latest
          #   bazel-config: ''
          # - name: WASM
          #   os: ubuntu-latest
          #   bazel-config: '--config=wasm'
          # - name: macOS
          #   os: macos-latest
          #   bazel-config: ''
          - name: Windows
            os: windows-latest
            bazel-config: ''
    
    steps:
      - name: Enable symlinks for Windows
        if: runner.os == 'Windows'
        run: git config --global core.symlinks true

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Diagnostics - Check repository contents
        shell: bash
        run: |
          echo "=== Repository root contents ==="
          ls -la || dir
          echo ""
          echo "=== Checking symlinks ==="
          if [ -L .lldb ]; then
            echo ".lldb is a symlink -> $(readlink .lldb)"
          else
            echo ".lldb is NOT a symlink (or doesn't exist)"
            ls -la .lldb 2>&1 || echo ".lldb not found"
          fi
          if [ -L .lldbinit ]; then
            echo ".lldbinit is a symlink -> $(readlink .lldbinit)"
          else
            echo ".lldbinit is NOT a symlink (or doesn't exist)"
            ls -la .lldbinit 2>&1 || echo ".lldbinit not found"
          fi
          if [ -L .bazelversion ]; then
            echo ".bazelversion is a symlink -> $(readlink .bazelversion)"
          else
            echo ".bazelversion is NOT a symlink (or doesn't exist)"
            ls -la .bazelversion 2>&1 || echo ".bazelversion not found"
          fi

      - name: Setup Bazel
        uses: bazel-contrib/setup-bazel@0.9.0
        with:
          bazelisk-cache: true
          disk-cache: ${{ github.workflow }}-${{ matrix.config.name }}
          repository-cache: true

      - run: bazel version
        shell: bash

      - name: Build all targets
        run: bazel build //... ${{ matrix.config.bazel-config }}
        shell: bash

      - name: Run demo target (verify runtime info)
        run: bazel run demo/hello-app ${{ matrix.config.bazel-config }}
        shell: bash

      - name: Run all tests
        run: bazel test //... ${{ matrix.config.bazel-config }}
        shell: bash
