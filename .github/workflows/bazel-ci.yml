name: Bazel CI

on:
  push:
    tags:
      - '*'
      - '*/*'

jobs:
  build-and-test:
    strategy:
      matrix:
        config:
          # - name: Linux GCC
          #   id: linux-gcc
          #   os: ubuntu-latest
          #   bazel-config: ''
          #   default-shell: bash
          # - name: WASM
          #   id: linux-wasm
          #   os: ubuntu-latest
          #   bazel-config: '--config=wasm'
          #   default-shell: bash
          # - name: macOS
          #   id: macos
          #   os: macos-latest
          #   bazel-config: ''
          #   default-shell: bash
          # - name: Windows MSVC x64
          #   id: windows-msvc-x64
          #   os: windows-latest
          #   bazel-config: ''
          #   default-shell: cmd
          #   output-base: ''
          - name: Windows MSVC ARM64
            id: windows-msvc-arm64
            os: windows-11-arm
            bazel-config: ''
            default-shell: cmd
            output-base: C:/_bazel  # Workaround for bazel-contrib/setup-bazel action on Windows ARM64 runner

    name: Check (${{ matrix.config.id }})
    runs-on: ${{ matrix.config.os }}

    steps:
      - name: Enable symlinks for Windows
        if: runner.os == 'windows'
        run: git config --global core.symlinks true

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Diagnostics - Check repository contents
        if: runner.os == 'Windows'
        shell: cmd
        run: |
          echo "=== Repository root contents ==="
          dir /A
          echo ""
          echo "=== Checking symlinks ==="
          echo "Checking .lldb:"
          if exist .lldb (
            dir .lldb
            if exist .lldb\* (
              echo ".lldb directory is accessible"
              dir .lldb
            ) else (
              echo ".lldb exists but content not accessible"
            )
          ) else (
            echo ".lldb not found"
          )
          echo ""
          echo "Checking .lldbinit:"
          if exist .lldbinit (
            type .lldbinit
          ) else (
            echo ".lldbinit not found"
          )

      #TODO: workaround fixing symlinkgs to submodule directory on Windows 
      # (it incorrectly makes it <SYMLINK> instead of <SYMLINKD>, so after pull it need to be fixed possibly by hook replacing them to mklink /d)

      # Workaround fix for "Setup Bazel" that fails on Windows due to symlink issues with .lldb and .lldbinit
      - name: Remove problematic symlinks on Windows
        if: runner.os == 'Windows'
        shell: cmd
        run: |
          if exist .lldb (
            echo "Removing .lldb symlink..."
            del .lldb
          )
          if exist .lldbinit (
            echo "Removing .lldbinit symlink..."
            del .lldbinit
          )

      - name: Setup Bazel
        uses: bazel-contrib/setup-bazel@0.18.0
        with:
          bazelisk-cache: true
          disk-cache: ${{ github.workflow }}-${{ matrix.config.id }}
          repository-cache: true
          # output-base: ${{ matrix.config.output-base }}

      - name: Bazel version and configuration
        run: |
          bazel version
          echo ""
          echo "=== Bazel configuration ==="
          bazel info

      - name: Build all targets
        run: bazel build //... ${{ matrix.config.bazel-config }}

      - name: Run demo target (verify runtime info)
        run: bazel run demo/hello-app ${{ matrix.config.bazel-config }}

      - name: Run all tests
        run: bazel test //... ${{ matrix.config.bazel-config }}
