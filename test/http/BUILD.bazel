load("@rules_python//python:defs.bzl", "py_test")
load("@tx-kit-ext//rules/build:tx_test.bzl", "tx_test")

# C++ HTTP client test (requires server to be running)
tx_test(
    name = "http_client_test",
    srcs = ["http_client_test.cpp"],
    deps = [
        "//src/pkg-app",
        "//src/pkg-http",
        "@googletest//:gtest_main",
    ],
    # Don't run this directly - use http_client test below
    tags = ["manual"],
)

# Wrapper test that starts server and runs C++ test
# Usage: bazel test //test/http:http_client
py_test(
    name = "http_client",
    srcs = ["//test/http/stub:stub_integration_test.py"],
    data = [
        ":http_client_test",
        "//test/http/stub:stub_server",
    ],
    main = "stub_integration_test.py",
    args = [
        "$(location :http_client_test)",
        "$(location //test/http/stub:stub_server)",
    ],
    # exclusive: prevent parallel execution with other tests (port conflicts)
    # requires-network: test uses network (local server on specific port)
    tags = ["exclusive", "requires-network"],

    # TODO: !!!! ALLOW TO RUN WASM INTEGRATION TESTS !!!!
    target_compatible_with = select({
        "@platforms//cpu:wasm32": ["@platforms//:incompatible"],
        "//conditions:default": [],
    }),
)
